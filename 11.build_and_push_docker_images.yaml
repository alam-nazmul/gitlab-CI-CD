### File name will be ".gitlab-ci.yml"

image: ubuntu:20.04

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH != "main" && $CI_PIPELINE_SOURCE != "merge_request_event" #branch is not main and it is not merge request
      when: never
    - when: always

#variables:  # Global variables
#  image_repo: docker.io/my-docker-id/myapp
#  image_version: v2.1


#stages:
#  - test
#  - build
#  - deploy

run_unit_tests:
  image: node:17-alpine3.14
  tags:
    - ec2
    - remote
    - docker
  before_script:
    - cd app
    - npm install




build_image:
  tags:
    - ec2
    - remote
    - shell
  script:
    - docker build . -t registry.gitlab.com/nazmul/my-app:1.0


push_image:
  needs:
    - build_image
  tags:
    - ec2
    - remote
    - shell
  before_script:
    - echo "Loging docker registry"
    - docker login -u nazmul -p 1234 registry.gitlab.com -u nazmul -p 1234
    -
  script:
    - docker push  registry.gitlab.com/nazmul/my-app:1.0